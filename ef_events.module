<?php
/**
 * @file
 * Code for the EF Events feature.
 */

include_once 'ef_events.features.inc';

/**
 * Implements hook_migrate_api().
 */
function ef_events_migrate_api() {
  $api = array(
    'api' => 2,
    'migrations' => array(
      'EFPaidEventProduct' => array('class_name' => 'EFPaidEventProduct'),
      'EFPaidEventNode' => array('class_name' => 'EFPaidEventNode'),
    ),
  );

  return $api;
}

/**
 * Implements hook_node_info().
 */
function ef_events_node_info() {
  $items = array(
    'event_payable' => array(
      'name' => t('Paid Event'),
      'base' => 'node_content',
      'description' => t('Post information about planned activities or meetings, which can be purchased.'),
      'has_title' => '1',
      'title_label' => t('Title'),
      'help' => '',
    ),
  );
  return $items;
}

/**
 * Implements
 */
function ef_events_menu_local_tasks_alter(&$data, $router_item, $root_path) {
  if ($root_path == 'node/%' && $router_item['page_arguments'][0]->type == 'event_payable') {
    $node = $router_item['page_arguments'][0];
    $attendees_tab = array(
      '#theme' => 'menu_local_task',
      '#link' => array(
        'href' => 'node/' . $node->nid . '/event-attendees',
        'tab_root_href' => 'node/' . $node->nid,
        'tab_parent_href' => 'node/' . $node->nid,
        'title' => t('Attendees'),
        'localized_options' => array(),
      ),
    );
    $data['tabs'][0]['output'][] = $attendees_tab;
    $stop = null;
  }
}

/**
 * Implements hook_form_alter().
 */
function ef_events_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'event_payable_node_form') {
    //$form['actions']['submit']['#submit'][] = '_ef_events_paid_event_redirect';
  }
}

/**
 * Implements hook_form_alter()
 */
function ef_events_form_commerce_cart_add_to_cart_form_alter(&$form, &$form_state, $form_id) {
  $form['submit']['#value'] = t('Attend');
}

function _ef_events_paid_event_redirect($form, &$form_state) {
  // No longer needed since decoupled from Registration, but keeping just in
  /// case we can reuse this.
  //$form_state['redirect'] = 'node/' . $form_state['node']->nid . '/registrations/settings';
}